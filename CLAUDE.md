# Claude Code プロジェクト設定

## 基本設定
- 言語: 日本語でやりとりする
- コミット時は必ずバージョンを更新する（js/version.js）
- プッシュ前に必ず全テストを実行して通過を確認

## AskUserQuestion ツールの活用（必須）

### 使用すべき場面
- **複数の選択肢がある時**: 実装方法、優先順位、機能選択など
- **曖昧な指示を受けた時**: 確認したい点を選択肢形式で提示
- **作業の優先順位を決める時**: どの順番で進めるか確認

### 使い方のルール
1. **選択肢はテキスト列挙ではなくAskUserQuestionで提示**
2. **オプションは2-4個**（多すぎると選びにくい）
3. **推奨オプションは先頭に配置**（ラベルに「(推奨)」追加）
4. **複数選択可能な場合は `multiSelect: true`**

### 例
```javascript
{
  "questions": [{
    "question": "どの機能を優先しますか？",
    "header": "優先度",
    "options": [
      {"label": "認証機能 (推奨)", "description": "ログイン必須化"},
      {"label": "テスト追加", "description": "E2Eテストの拡充"},
      {"label": "UI改善", "description": "レスポンシブ対応"}
    ],
    "multiSelect": true
  }]
}
```

### やってはいけないこと
- 選択肢をテキストで列挙するだけ
- 「どれにしますか？」と聞いて入力させる
- オプション5個以上

## サブエージェント活用（Task Tool）

### 使用すべき場面
- **テスト作成**: 複数のテストファイルを同時に作成する場合
- **コード調査**: 複数ファイルの調査を並列で実行
- **複雑なタスク**: 独立した作業を分割して並列処理

### サブエージェントタイプ
| タイプ | 用途 |
|--------|------|
| `general-purpose` | テスト作成、複雑な実装、調査 |
| `Explore` | コードベース探索、ファイル検索 |
| `Plan` | 実装計画の設計 |

### 並列実行の例
```
ユーザー: テストを追加して
↓
サブエージェント1: 画像アップロードテスト作成
サブエージェント2: バリデーションテスト作成
サブエージェント3: エラーハンドリングテスト作成
（同時に実行）
```

## 並列化方針
- **必ず並列化**: 独立したテストファイル作成、調査タスク
- **単一メッセージで複数Task**: `run_in_background` 不要で自動並列
- **依存関係がある場合のみ直列**: 前のタスクの結果が必要な場合

## Agent Skills（自動発動）

`.claude/skills/` に以下のスキルを配置。**状況に応じて自動的に参照すること。**

### スキル一覧と発動条件

| スキル | 発動条件 | 内容 |
|--------|----------|------|
| **feature-development** | 「〇〇を作って」 | **新機能開発のフェーズ管理（最重要）** |
| **communication** | 常時適用 | コミュニケーションルール、報告形式 |
| **ask-user-question** | 選択肢を提示する時 | AskUserQuestionツールの使い方 |
| **testing** | コード変更後、プッシュ前 | Playwrightテストの実行方法 |
| **version-release** | 「プッシュして」 | バージョン管理とリリース手順 |
| **self-improvement** | タスク完了時、エラー時 | 実行記録・評価のSupabase保存 |
| **supabase** | DB操作時 | Supabase接続・API呼び出し方法 |
| **bulk-module** | 一括入力画面の変更時 | ES Modulesの構成と修正方法 |
| **admin-improvements** | 管理画面の改善時 | 管理画面の改善課題一覧 |
| **file-structure** | ファイル探索時 | プロジェクト構成と各ファイルの役割 |

### スキル参照の例
```
ユーザー: 管理画面にフィルター追加して
↓
1. admin-improvementsスキルを参照（改善課題確認）
2. file-structureスキルを参照（対象ファイル確認）
3. 実装
4. testingスキルを参照（テスト実行）
5. version-releaseスキルを参照（プッシュ時）
```

## テスト方針
- 変更後は必ずテストを実行
- `setupAuthMockWithMasterData` を使用して認証をモック
- 全テスト通過を確認してからコミット
- 新機能追加時はサブエージェントでテスト作成を並列化

## Supabaseスキーマ注意点
- ステータス値: `'draft'`（承認待ち）、`'submitted'`（承認済み）
- カラム名: `inspection_start`, `inspection_end`, `display_duration`, `announcement`, `poster_position`
- 古いカラム名は使用禁止: `start_date`, `end_date`, `display_time`, `notice_text`, `position`

## コード品質
- 型比較は `String()` で統一
- エラーハンドリングは防御的に（null返却など）
- トーストには必ず `.show` クラスを付与
- エラーメッセージは「申請に失敗しました」で統一

## 新機能開発フロー（必須）

### 「〇〇を作って」と言われたら

**絶対にすぐ実装を始めない。** 以下のフェーズを踏む:

```
フェーズ1: 調査・仕様確認 ← AskUserQuestionで確認
フェーズ2: 設計書作成 ← チェックリストを作成
フェーズ3: 実装 ← コードを書く
フェーズ4: テスト ← 動作確認
```

### フェーズ1で確認すべき項目

1. **Supabase関連**
   - 使用するテーブルは？
   - RLSポリシーの現状は？
   - 認証設定（メール確認等）は？

2. **既存パターン**
   - 似た機能はあるか？
   - UIは既存のものを参考にするか？
   - IDの重複はないか？

3. **要件詳細**
   - 誰が使う機能か？
   - 必須/任意項目は？
   - エラー時の挙動は？

### ユーザーへのお願いテンプレート

新機能を依頼する時、以下の情報があると効率的:

```
【機能概要】
〇〇ができる機能

【環境情報】
- 使用テーブル: signage_xxx
- RLSポリシー: SELECT/INSERT/UPDATE各1つ
- 認証設定: メール確認は無効

【参考にする既存機能】
- UIは〇〇モーダルと同じスタイルで
- 処理は〇〇関数を参考に

【要件】
- 必須項目: A, B, C
- 任意項目: D, E
- エラー時は〇〇を表示
```
