---
name: quality-first
description: 品質ファーストの開発姿勢。実装前に必ず参照。一発で正しく動作するコードを書く。
allowed-tools: Read, Grep, Bash, Edit
---

# 品質ファースト開発スキル

## 🎯 基本原則

**「完了」は自分でテストしてから言う**

## 📊 このプロジェクトの問題パターン分析

### 統計（60コミット分析）
- fix: 18コミット（30%）← 多すぎ
- feat: 25コミット（42%）
- refactor: 10コミット（17%）
- docs: 7コミット（12%）

**問題**: 修正コミットが30%は異常。本来5%以下であるべき。

### 典型的な失敗パターン

#### パターン1: テストせずに「完了」報告
```
実装 → コミット → 「完了！」
↓
ユーザー「動かない」
↓
修正 → コミット → 「今度こそ完了！」
↓
ユーザー「まだ動かない」
↓
（7往復...）
```

**正しい流れ**:
```
実装 → ローカルテスト → DBデータ確認 → コンソールエラー0確認 → コミット → 「テスト済みです」報告
```

---

#### パターン2: 推測による修正
```
エラー発生
↓
「たぶん〇〇が原因」
↓
推測で修正 → 動かない
↓
「じゃあ△△かも」
↓
また推測修正 → 動かない
```

**正しいアプローチ**:
```
エラー発生
↓
詳細ログ追加
↓
データフロー全体を追跡
↓
根本原因を特定
↓
原因に対する修正
↓
1回で解決
```

---

#### パターン3: 部分理解での実装
```
要件を聞く
↓
「だいたいわかった」
↓
実装開始
↓
仕様漏れ発覚
↓
追加実装 → また漏れ → また追加...
```

**正しいアプローチ**:
```
要件を聞く
↓
全体像を図解
↓
エッジケースを洗い出し
↓
ユーザーに確認
↓
完全理解してから実装
↓
1回で完成
```

---

## ✅ 実装前チェックリスト

### Phase 1: 理解（30%の時間）

#### 要件の完全理解
```
□ 何を作るか明確か？
□ なぜ必要か理解したか？
□ 誰が使うか分かっているか？
□ どこに影響するか把握したか？
□ エッジケースを考えたか？
```

#### 制約の確認（docs/RLS_SCHEMA_REFERENCE.md 必読）
```
□ RLSポリシーは？ → 対象テーブルのポリシー確認
□ フィールド名は？ → snake_case vs camelCase 確認
□ データベーススキーマは？ → フィールド一覧確認
□ 既存コードとの関係は？
□ パフォーマンスへの影響は？
□ 過去の失敗パターンに該当しないか？ → docs/FAILURE_PATTERNS.md 検索
```

#### 不明点の質問
```
□ 曖昧な部分はないか？
□ 想定と実際のギャップは？
□ ユーザーに確認すべき点は？
```

**Phase 1で30%の時間を使う。焦って実装しない。**

---

### Phase 2: 設計（20%の時間）

#### アーキテクチャ設計
```
□ データフローを図解したか？
□ 影響範囲を特定したか？
□ エラーハンドリングを考えたか？
□ ロールバック方法は？
```

#### テスト計画
```
□ 正常系のテストケース
□ 異常系のテストケース
□ 境界値のテストケース
□ パフォーマンステスト
```

#### コードレビュー（自分で）
```
□ 既存のパターンに従っているか？
□ ネーミングは適切か？
□ コメントは十分か？
□ リファクタリングの余地は？
```

---

### Phase 3: 実装（30%の時間）

#### コーディング
```
□ 設計通りに実装
□ エッジケースの処理
□ エラーハンドリング
□ 詳細ログ追加（最初から）
```

#### セルフレビュー
```
□ コードを読み直す
□ バグがないか確認
□ パフォーマンス問題ないか
□ セキュリティ問題ないか
```

---

### Phase 4: テスト（20%の時間）

#### 必須テスト項目
```
□ 正常系動作確認
□ エラー発生時の挙動
□ DBに正しく保存されるか
□ UI正しく表示されるか
□ コンソールエラー0件
□ 既存機能が壊れていないか
```

#### テストの証跡
```
□ スクリーンショット
□ コンソールログ
□ DBクエリ結果
□ テストケース実行結果
```

**すべてPASSしてから初めて「完了」と言う**

---

## 🚫 やってはいけないこと

### 1. 推測で修正する
```
❌ 「たぶん〇〇が原因」
✅ 「ログで確認したところ、〇〇が原因です」
```

### 2. テストせずに報告
```
❌ 「実装しました！」
✅ 「実装し、テストも完了しました。〇〇と〇〇を確認済みです」
```

### 3. 部分的な理解で進める
```
❌ 「とりあえず実装して様子見ます」
✅ 「要件を完全に理解するため、〇〇を確認させてください」
```

### 4. ワークアラウンド重ねがけ
```
❌ 動かない → ワークアラウンド追加 → また動かない → また追加...
✅ 動かない → 根本原因特定 → 原因修正 → 解決
```

### 5. ユーザーをテスターにする
```
❌ 「実装したので試してください」
✅ 「実装し、以下のテストを実施しました: ...」
```

---

## ✅ 目指すべき姿

### 理想的なコミット比率
- feat: 70%（新機能）
- docs: 15%（ドキュメント）
- refactor: 10%（改善）
- fix: 5%以下（バグ修正）

### 現実
- feat: 42%
- fix: 30% ← **6倍多い**
- refactor: 17%
- docs: 12%

### 往復回数
- 理想: 1-2往復で完結
- 現実: 平均3-5往復、最大7往復

**目標**: fix:を5%以下に、往復を1-2回に削減

---

## 📝 実装時の必須手順

### 1. 理解フェーズ（絶対にスキップしない）
```
1. 要件を完全に理解する
2. 不明点は質問する
3. データフローを図解する
4. 影響範囲を特定する
5. RLS/スキーマ確認 → docs/RLS_SCHEMA_REFERENCE.md を参照
6. 失敗パターン確認 → docs/FAILURE_PATTERNS.md を検索
```

### 2. 設計フェーズ（焦らない）
```
1. 全体設計を考える
2. エッジケースを洗い出す
3. テストケースを考える
4. ユーザーに設計確認
5. 垂直展開：根本原因を特定
   - なぜこの問題が起きたのか？
   - より深い層に問題はないか？
   - 本質的な解決策は何か？
```

### 3. 実装フェーズ（丁寧に）
```
1. 設計通りに実装
2. 詳細ログを最初から追加
3. エラーハンドリング完備
4. セルフコードレビュー
```

### 4. テストフェーズ（徹底的に）
```
1. 正常系テスト
2. 異常系テスト
3. DB確認
4. コンソール確認
5. 既存機能確認
6. Playwright テスト実行（必須）
   → npx playwright test
   → 失敗したら必ず修正
   → PASSするまでプッシュ禁止
7. 類似箇所の水平展開チェック（必須）
8. 全体リント・テスト実施（必須）
```

**重要**: テストが赤 = プロダクトが壊れている = プッシュ禁止

### 5. 報告フェーズ（誠実に）
```
1. 何を実装したか
2. どうテストしたか
3. 結果はどうだったか
4. 懸念点はないか
```

---

## 🎯 チェックポイント

### コミット前
```
□ 自分でテストしたか？
□ DBに正しく保存されるか確認したか？
□ コンソールエラー0件か？
□ 既存機能を壊していないか？
□ ドキュメント更新したか？
```

### 報告前
```
□ 実際に動作するか確認したか？
□ エッジケースもテストしたか？
□ 証跡（ログ・スクショ）はあるか？
□ 自信を持って「完了」と言えるか？
```

**すべてYESでなければ報告しない**

---

## 🔧 ツール活用

### 1. TodoWrite
- タスクを細分化
- 進捗を見える化
- 完了を慎重に判断

### 2. AskUserQuestion
- 不明点は即質問
- 推測で進めない
- 選択肢を提示

### 3. ログ追加
- 最初から詳細に
- データフローを追跡
- 問題の早期発見

---

## 💪 今後の改善目標

### 短期（次のセッション）
- fix:コミットを50%削減（30% → 15%）
- 往復を半減（平均3往復 → 1.5往復）
- テスト報告を100%実施

### 中期（1ヶ月）
- fix:コミットを80%削減（30% → 6%）
- 往復を1-2回に固定
- 品質チェックリスト100%遵守

### 長期（3ヶ月）
- fix:コミット5%以下
- 往復1回が標準
- ユーザーから「信頼できる」評価

---

**このスキルを毎回の実装前に参照すること。**
