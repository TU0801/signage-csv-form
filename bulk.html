<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>一括入力 - 点検CSV作成フォーム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bulk.css">
    <link rel="stylesheet" href="css/bulk-modals.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>一括入力 <span id="appVersion" class="version-badge"></span></h1>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <a href="index.html" class="btn-header">1件入力</a>
                <a href="admin.html" class="btn-header" id="adminLink" style="display: none;">管理</a>
                <span id="userEmail" style="color: rgba(255,255,255,0.8); font-size: 0.875rem;"></span>
                <button class="btn-header" id="logoutBtn">ログアウト</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <!-- 管理者専用: メンテナンス会社選択 -->
            <div id="adminVendorSelectGroup" style="display: none; margin: 1rem 1rem 0 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                <label style="font-weight: 700; color: #856404; display: block; margin-bottom: 0.5rem;">
                    <span style="background: #ffc107; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.5rem;">管理者</span>
                    入力するメンテナンス会社を選択
                </label>
                <select id="adminVendorSelect" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ffc107;">
                    <option value="">-- メンテナンス会社を選択 --</option>
                </select>
            </div>

            <!-- メインツールバー -->
            <div class="bulk-toolbar">
                <!-- 左: 行操作 -->
                <div class="toolbar-section">
                    <span class="toolbar-label">行操作</span>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" id="addRowBtn" title="新しい行を追加 (Ctrl+Enter)">
                            <span class="btn-icon">+</span> 行を追加
                        </button>
                        <button class="btn btn-outline btn-sm" id="duplicateBtn" title="選択した行を複製 (Ctrl+D)">複製</button>
                        <button class="btn btn-outline btn-sm" id="bulkEditBtn" disabled title="選択した行を一括編集 (Ctrl+E)">一括編集</button>
                        <button class="btn btn-outline btn-sm btn-danger-outline" id="deleteSelectedBtn" disabled title="選択した行を削除 (Delete)">削除</button>
                    </div>
                </div>

                <!-- 中央: データ入出力 -->
                <div class="toolbar-section">
                    <span class="toolbar-label">データ入出力</span>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" id="pasteBtn" title="Excelからデータを貼り付け">Excelから取込</button>
                        <div class="toolbar-divider"></div>
                        <select id="templateSelect" class="form-select form-select-sm">
                            <option value="">テンプレート</option>
                        </select>
                        <button class="btn btn-outline btn-sm" id="saveTemplateBtn" title="現在の設定をテンプレートとして保存">テンプレ保存</button>
                    </div>
                </div>

                <!-- 右: 統計 -->
                <div class="toolbar-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalCount">0</span>
                        <span class="stat-label">件</span>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item stat-success">
                        <span class="stat-value" id="validCount">0</span>
                        <span class="stat-label">有効</span>
                    </div>
                    <div class="stat-item stat-error">
                        <span class="stat-value" id="errorCount">0</span>
                        <span class="stat-label">エラー</span>
                    </div>
                    <div class="stat-item stat-selected">
                        <span class="stat-value" id="selectedCount">0</span>
                        <span class="stat-label">選択中</span>
                    </div>
                </div>
            </div>

            <!-- フィルター -->
            <div class="filter-bar">
                <span class="filter-label">表示:</span>
                <button class="filter-btn active" data-filter="all">すべて</button>
                <button class="filter-btn filter-valid" data-filter="valid">有効のみ</button>
                <button class="filter-btn filter-error" data-filter="error">エラーのみ</button>
                <span id="filterInfo" class="filter-info"></span>
                <button id="requestBuildingBtn" class="btn btn-outline btn-sm" style="display: none; margin-left: auto;">
                    + 物件追加リクエスト
                </button>
            </div>

            <!-- テーブル -->
            <div class="bulk-table-container">
                <table class="bulk-table" id="bulkTable">
                    <thead>
                        <tr>
                            <th class="col-drag-handle"></th>
                            <th class="col-checkbox"><input type="checkbox" id="selectAll" title="すべて選択"></th>
                            <th class="col-row-num">No</th>
                            <th class="col-property required">物件</th>
                            <th class="col-terminal">端末</th>
                            <th class="col-vendor required">受注先</th>
                            <th class="col-inspection required">点検種別</th>
                            <th class="col-date">点検開始日</th>
                            <th class="col-date">点検終了日</th>
                            <th class="col-remarks">備考</th>
                            <th class="col-time">秒数</th>
                            <th class="col-detail">詳細</th>
                            <th class="col-status">状態</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- 動的に行を追加 -->
                    </tbody>
                </table>

                <div class="bulk-empty" id="emptyState">
                    <div class="bulk-empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            <path d="M12 11v6M9 14h6"/>
                        </svg>
                    </div>
                    <h3>データがありません</h3>
                    <p>「行を追加」または「Excelから取込」で入力を開始してください</p>
                    <button class="btn btn-primary" id="emptyAddBtn">行を追加して始める</button>
                </div>
            </div>

            <!-- フッター -->
            <div class="bulk-footer">
                <div class="footer-left">
                    <button class="btn btn-success btn-lg" id="saveBtn" disabled>
                        <span class="btn-icon">↑</span> 申請する
                    </button>
                    <span class="footer-hint">管理者の承認後に反映されます</span>
                </div>
                <div class="footer-right">
                    <button class="btn btn-outline btn-sm" id="downloadCsvBtn" disabled title="CSVファイルとしてダウンロード">CSVダウンロード</button>
                    <button class="btn btn-outline btn-sm" id="copyCsvBtn" disabled title="CSV形式でクリップボードにコピー">CSVコピー</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ペーストモーダル -->
    <div class="modal-overlay" id="pasteModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Excelからデータを取り込む</h3>
                <button class="modal-close" id="closePasteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">Excelでコピーしたデータをそのまま貼り付けてください。<br>
                <small style="color: #64748b;">ヘッダー行（「物件コード」等）がある場合は自動でスキップされます。</small></p>
                <textarea class="paste-textarea" id="pasteArea" placeholder="ここにExcelからコピーしたデータを貼り付け..."></textarea>

                <details class="paste-help" style="margin-top: 0.75rem;">
                    <summary style="cursor: pointer; font-weight: 600; color: #1a56db; font-size: 0.85rem;">
                        📋 列の順序・対応形式を確認
                    </summary>
                    <div style="background: #f8fafc; border-radius: 6px; padding: 0.75rem; margin-top: 0.5rem; font-size: 0.8rem;">
                        <p style="margin: 0 0 0.5rem; font-weight: 500;">対応する列の順序:</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <tr style="background: #e2e8f0;">
                                <th style="padding: 0.3rem; text-align: left; border: 1px solid #cbd5e1;">A列</th>
                                <th style="padding: 0.3rem; text-align: left; border: 1px solid #cbd5e1;">B列</th>
                                <th style="padding: 0.3rem; text-align: left; border: 1px solid #cbd5e1;">C列</th>
                                <th style="padding: 0.3rem; text-align: left; border: 1px solid #cbd5e1;">D列</th>
                                <th style="padding: 0.3rem; text-align: left; border: 1px solid #cbd5e1;">E列</th>
                                <th style="padding: 0.3rem; text-align: left; border: 1px solid #cbd5e1;">F列</th>
                                <th style="padding: 0.3rem; text-align: left; border: 1px solid #cbd5e1;">G列</th>
                            </tr>
                            <tr>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">物件コード</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">端末ID</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">受注先名</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">点検種別</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">開始日</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">終了日</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">備考</td>
                            </tr>
                            <tr style="color: #64748b;">
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">120406</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">z1003A01</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">山本クリーン...</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">エレベーター...</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">2025/1/15</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">2025/1/15</td>
                                <td style="padding: 0.3rem; border: 1px solid #cbd5e1;">午前中</td>
                            </tr>
                        </table>
                        <p style="margin: 0.5rem 0 0; color: #64748b; font-size: 0.7rem;">
                            ※ 端末ID（B列）は省略可能です。省略時は物件から自動設定されます。
                        </p>
                    </div>
                </details>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button class="btn btn-outline btn-sm" id="downloadTemplateBtn" title="Excelテンプレートをダウンロード">📥 テンプレート</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-outline" id="cancelPasteBtn">キャンセル</button>
                    <button class="btn btn-primary" id="importPasteBtn">取り込む</button>
                </div>
            </div>
        </div>
    </div>

    <!-- テンプレート保存モーダル -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>テンプレートを保存</h3>
                <button class="modal-close" id="closeTemplateModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="templateName">テンプレート名</label>
                    <input type="text" id="templateName" class="form-control" placeholder="例: A社定期清掃">
                </div>
                <div id="templatePreview" class="template-preview">
                    <!-- テンプレート内容のプレビュー -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelSaveTemplate">キャンセル</button>
                <button class="btn btn-primary" id="confirmSaveTemplate">保存</button>
            </div>
        </div>
    </div>

    <!-- トースト通知用 -->
    <div id="toast" class="toast"></div>

    <script src="js/version.js"></script>
    <script src="js/config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.APP_VERSION) {
                document.getElementById('appVersion').textContent = window.APP_VERSION;
            }
        });
    </script>
    <script type="module" src="js/bulk.js"></script>
</body>
</html>
