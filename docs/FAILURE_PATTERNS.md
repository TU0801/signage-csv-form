# 失敗パターンデータベース

**目的**: 同じミスを二度と繰り返さない
**更新**: 新しい失敗が発生したら即座に追加

---

## 📊 統計

- **総パターン数**: 15
- **最頻パターン**: RLS確認漏れ（10回）
- **最大往復数**: 7回（ユーザー編集）

---

## 🔴 カテゴリ別失敗パターン

### 1. RLS/権限関連（10件）

#### #1-1: UPDATE成功するがデータ保存されない
- **発生回数**: 3回
- **症状**: エラーなし、でもDBが更新されない
- **原因**: RLSポリシーがUPDATEを許可していない
- **対策**:
  ```sql
  -- 実装前に必ず確認
  SELECT * FROM pg_policies WHERE tablename = 'target_table';
  ```
- **チェックリスト**: `□ RLSポリシー確認済み`

#### #1-2: SELECT結果が空配列
- **発生回数**: 4回
- **症状**: データはあるのにSELECTが[]を返す
- **原因**: SELECT権限がない
- **対策**: RLSポリシーでSELECT権限確認
- **チェックリスト**: `□ SELECT権限確認済み`

#### #1-3: 406 Not Acceptable
- **発生回数**: 3回
- **症状**: .single()で406エラー
- **原因**: RLSで複数行/0行が返される
- **対策**: .single()を避ける、またはRLS確認
- **チェックリスト**: `□ .single()使用時は結果数確認`

---

### 2. フィールド名不一致（8件）

#### #2-1: notice_text vs default_text
- **発生回数**: 2回（admin, input）
- **症状**: データが表示されない、常に空
- **原因**: DBとコードでフィールド名が違う
- **対策**: スキーマを見て正確に記述
- **チェックリスト**: `□ フィールド名をスキーマと照合`

#### #2-2: vendor_name vs vendorName
- **発生回数**: 3回
- **症状**: undefinedエラー
- **原因**: snake_case vs camelCase混在
- **対策**: getAllMasterDataCamelCase()でマッピング確認
- **チェックリスト**: `□ snake_case/camelCase統一確認`

#### #2-3: category意味の混同
- **発生回数**: 2回
- **症状**: カテゴリマスタと画像区分が混同
- **原因**: 同じ名前で別の意味
- **対策**: 明確な命名（category vs classification）
- **チェックリスト**: `□ 用語の意味を明確化`

---

### 3. UI/CSS関連（15件）

#### #3-1: テキストオーバーラップ
- **発生回数**: 4回
- **症状**: 文字が重なる
- **原因**: gap不足、padding不足
- **対策**: gap 2rem、padding十分に
- **チェックリスト**: `□ 長いテキストでテスト`

#### #3-2: 省略記号（...）表示
- **発生回数**: 5回
- **症状**: 文字が途中で切れる
- **原因**: overflow: hidden, text-overflow: ellipsis
- **対策**: 必要な箇所のみ省略、基本は全文表示
- **チェックリスト**: `□ 実データでUI確認`

#### #3-3: グリッド崩れ
- **発生回数**: 3回
- **症状**: レイアウトが崩れる
- **原因**: minmax設定ミス、overflow設定ミス
- **対策**: overflow: hidden、適切なminmax
- **チェックリスト**: `□ 長いデータでレイアウト確認`

#### #3-4: CSS全体破損
- **発生回数**: 1回
- **症状**: 全スタイル消失
- **原因**: head/tailコマンド失敗
- **対策**: Read/Edit toolsのみ使用、ファイル操作コマンド禁止
- **チェックリスト**: `□ ファイル操作はRead/Editのみ`

---

### 4. フォーム/バリデーション（5件）

#### #4-1: Invalid form control
- **発生回数**: 2回
- **症状**: 「invalid form control with name=''」大量発生
- **原因**: 非表示フィールドにrequired属性
- **対策**: 非表示時はdisabled=trueにする
- **チェックリスト**: `□ 非表示フィールドはdisabled`

#### #4-2: 変数重複宣言
- **発生回数**: 2回
- **症状**: SyntaxError
- **原因**: 同じスコープでconst重複
- **対策**: 変数宣言を確認してから追加
- **チェックリスト**: `□ 既存変数を検索`

#### #4-3: イベントハンドラー重複
- **発生回数**: 1回
- **症状**: フォームが二重送信される
- **原因**: addEventListener + form.onsubmit両方
- **対策**: どちらか一方のみ使用
- **チェックリスト**: `□ イベントハンドラー重複確認`

---

### 5. データ構造関連（7件）

#### #5-1: Terminal ID表示問題
- **発生回数**: 5回
- **症状**: 端末が表示されない、件数が合わない
- **原因**: フラット vs グループ化の混在
- **対策**: getAllMasterData()の構造を理解
- **チェックリスト**: `□ データ構造を図解`

#### #5-2: 再グループ化バグ
- **発生回数**: 2回
- **症状**: データが重複/欠損
- **原因**: 既にグループ化済みを再グループ化
- **対策**: renderProperties()で再グループ化しない
- **チェックリスト**: `□ データは既にグループ化済みか確認`

---

### 6. モーダル/状態管理（7件）

#### #6-1: Modal表示されない
- **発生回数**: 3回
- **症状**: ボタン押してもモーダル出ない
- **原因**: .active クラス追加漏れ
- **対策**: modal.classList.add('active')
- **チェックリスト**: `□ モーダル表示確認`

#### #6-2: Null参照エラー
- **発生回数**: 4回
- **症状**: Cannot read properties of null
- **原因**: querySelector()がnull返す
- **対策**: Optional chaining (?.)使用
- **チェックリスト**: `□ 全querySelectorに?.追加`

#### #6-3: querySelector結果の確認漏れ
- **発生回数**: 5回
- **症状**: Cannot read properties of null
- **原因**: querySelector()結果を確認せずにメソッド呼び出し
- **対策**: Optional chaining (?.) または if チェック
- **チェックリスト**: `□ 全querySelectorに?.または存在確認`

---

### 7. 要素削除時の確認漏れ

#### #7-1: HTML削除時のJavaScript確認漏れ
- **発生回数**: 2回（今回含む）
- **症状**: 削除した要素へのイベントリスナーでnullエラー
- **原因**: HTMLを削除したがJavaScriptのコードを確認・削除しなかった
- **対策**:
  ```bash
  # 要素削除前に必ず実行
  grep -r "display-time\|btn-detail" js/
  # 全ての参照を確認してから削除
  ```
- **チェックリスト**: `□ 削除要素の全参照をgrepで確認`
- **重要度**: HIGH（基本的なミス）

#### #7-2: CSS削除時のHTML確認漏れ
- **発生回数**: 1回
- **症状**: スタイルが適用されない
- **原因**: CSSクラス削除したがHTML側で使用中
- **対策**: grep でクラス名の全使用箇所確認
- **チェックリスト**: `□ CSSクラス削除前に全参照確認`

---

### 8. 局所的修正で終わらせる（NEW - 2026-01-03） ⭐️ 最新・重要

#### #8-1: 問題箇所のみ修正、類似箇所を放置
- **発生回数**: 多数（継続的な問題）
- **症状**: 1箇所修正したが、同じバグが別の場所で発生
- **原因**: 修正後に水平展開・垂直展開を実施しなかった
- **対策**:
  ```bash
  # 1. 類似箇所の検索（水平展開）
  grep -r "修正した関数名\|修正したパターン" js/

  # 2. 同じカテゴリの問題を検索（垂直展開）
  grep -r "未定義変数\|フィールド名不一致" js/

  # 3. CSSリントチェック
  find css -name "*.css" -exec sh -c 'grep -o "{" "$1" | wc -l' _ {} \;

  # 4. 全ボタンクリックテスト
  npx playwright test
  ```
- **チェックリスト**:
  ```
  □ 同じパターンが他にもないか検索
  □ 類似ファイルで同じ問題がないか確認
  □ CSSリント・JSリント実施
  □ 全機能テスト実施
  □ コンソールエラー0件確認
  ```
- **重要度**: CRITICAL（商用レベルの品質意識）
- **教訓**:
  - 「1箇所修正したら満足」は NG
  - 「類似調査・水平展開・垂直展開」は必須
  - 「全体的な品質チェック」を習慣化
- **垂直展開の例**:
  ```
  【表面】vendors 未定義エラー
     ↓ なぜ？
  【中間】関数内で変数宣言していない
     ↓ なぜ宣言が必要？
  【深層】個別にデータ取得している
     ↓ なぜ個別取得？
  【根本】getAllMasterDataCamelCase() が id を返していない
     ↓ 解決策
  1. id を含めるように修正
  2. 個別取得を削除
  3. キャッシュ再利用
  ```
- **水平展開の例**:
  ```
  script.js で vendors 未定義
     → admin.js でも同様の問題ないか？
     → bulk.js でも同様の問題ないか？
     → 他の変数（properties等）でも同じ問題ないか？
  ```

---

## 🔄 パターン活用方法

### 実装前（必須）
```bash
# 1. 作業内容をキーワード化
例: 「ユーザー編集機能を実装」→ "UPDATE", "RLS", "profiles"

# 2. FAILURE_PATTERNS.md を検索
grep -i "UPDATE\|RLS\|profiles" docs/FAILURE_PATTERNS.md

# 3. 該当パターンのチェックリストを実行
□ RLSポリシー確認済み
□ フィールド名確認済み
□ 対策コード実装済み
```

### デバッグ時
```bash
# 1. エラーメッセージ/症状をキーワード化
例: "Cannot read properties of null" → "null", "querySelector"

# 2. FAILURE_PATTERNS.md を検索
grep -i "null\|querySelector" docs/FAILURE_PATTERNS.md

# 3. 該当パターンの対策を実施
```

### レビュー時
```
1. チェックリスト全項目確認
2. パターンに該当しないか確認
```

---

## 🔍 クイックリファレンス

### 症状別検索ガイド

| 症状 | 検索キーワード | 該当パターン |
|------|--------------|------------|
| データが保存されない | "UPDATE\|保存" | #1-1 |
| SELECTが空配列 | "SELECT\|空配列" | #1-2 |
| 406エラー | "406\|single" | #1-3 |
| undefinedエラー | "undefined\|フィールド名" | #2-1, #2-2 |
| 文字が重なる | "オーバーラップ\|重なる" | #3-1 |
| nullエラー | "null\|querySelector" | #6-2, #6-3 |
| 削除後エラー | "削除\|null\|イベント" | #7-1 |

### 作業別検索ガイド

| 作業内容 | 検索キーワード | 該当パターン |
|---------|--------------|------------|
| ユーザー編集 | "UPDATE\|RLS\|profiles" | #1-1 |
| データ取得 | "SELECT\|RLS\|権限" | #1-2 |
| フォーム実装 | "フォーム\|バリデーション" | #4-1, #4-2 |
| モーダル実装 | "モーダル\|querySelector" | #6-1, #6-2 |
| 要素削除 | "削除\|grep\|参照" | #7-1 |
| CSS変更 | "CSS\|overflow\|gap" | #3-1, #3-2 |

---

## 📈 パターン追加ルール

新しい失敗が発生したら：

```markdown
### #X-Y: [問題名]
- **発生回数**: 1回
- **症状**: [何が起きたか]
- **原因**: [なぜ起きたか]
- **対策**: [どう防ぐか]
- **チェックリスト**: `□ [確認項目]`
```

即座に追加し、次回から活用。

---

**失敗から学び、二度と繰り返さない。**
