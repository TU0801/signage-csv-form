# 反省と教訓 - 2025-12-31セッション

## 🔴 問題：ユーザー編集で保守会社が反映されない

### 往復回数：7回
- v1.20.2: フォーム二重送信修正
- v1.20.3: .single()削除
- v1.20.4: null参照修正
- v1.20.5: loadAllData追加
- v1.20.6: デバッグログ追加
- v1.20.7: UPDATE/SELECT分離
- v1.20.8: 詳細ログ追加
- **最終**: RLSポリシー修正で解決

---

## 🤔 なぜ往復が多かったか

### 失敗1: 根本原因の特定を怠った

**やったこと**:
- エラーメッセージから推測
- 表面的な修正（.single()削除、nullチェック等）
- ワークアラウンド重ねがけ

**やるべきだったこと**:
- 最初からUPDATE/SELECT両方のログ確認
- Supabaseの実際のデータを確認
- RLSポリシーを最初にチェック

**教訓**: **症状ではなく、原因を特定してから修正する**

---

### 失敗2: テストせずに「完了」報告

**やったこと**:
- コード修正→即コミット→「完了！」報告
- ユーザーに確認を依頼
- 動かない→また修正

**やるべきだったこと**:
```
1. 修正
2. ローカルで動作確認（デバッグパネル使用）
3. コンソールログ確認
4. DBで実際のデータ確認
5. 完全に動作確認後に報告
```

**教訓**: **「完了」は自分で動作確認してから言う**

---

### 失敗3: データフローの理解不足

**問題**:
```
UPDATE → データ保存
SELECT → データ取得
表示 → masterData.vendorsから参照
```

このフロー全体を理解せず、部分的に修正していた。

**やるべきだったこと**:
1. UPDATEが本当に成功しているか確認（DBチェック）
2. SELECTが正しいデータを返しているか確認
3. masterData.vendorsが最新か確認
4. vendor_id比較ロジックが正しいか確認

**教訓**: **データフローの全体像を把握してから修正**

---

### 失敗4: RLSポリシーの知識不足

**問題**:
- RLSポリシーが何をブロックしているか理解していなかった
- エラーが出ないケース（silently blocked）を想定していなかった

**やるべきだったこと**:
1. 最初にRLSポリシーをチェック
2. `UPDATE signage_profiles SET vendor_id = ...`が許可されているか確認
3. 必要ならSQL修正から始める

**教訓**: **Supabase使用時は、RLSポリシーを最初に確認**

---

### 失敗5: ログ戦略の甘さ

**問題**:
- 最初は最小限のログ
- エラーが出てから追加
- 何度も「もっとログを」と追加

**やるべきだったこと**:
- 最初から全フロー（UPDATE開始→結果→SELECT→表示）にログ
- データの変化を追跡
- 1回で原因特定

**教訓**: **複雑な処理は最初から詳細ログを入れる**

---

## ✅ 正しいアプローチ（次回から）

### ステップ1: 原因の特定（30分）
```
1. エラーメッセージ確認
2. コンソールログで全フロー追跡
3. Supabaseで実データ確認
4. RLSポリシー確認
5. 根本原因を特定
```

### ステップ2: 修正（30分）
```
1. 根本原因に対する修正
2. ローカルでテスト
3. 動作確認（実際にDBが更新されるか）
```

### ステップ3: 報告（5分）
```
1. 修正内容
2. テスト結果
3. 動作確認済みであることを明記
```

**合計**: 1時間で完結すべきだった（実際は7往復）

---

## 📊 時間の無駄

- **無駄にした時間**: 約2時間
- **原因**: 推測による修正の繰り返し
- **効率**: 30%（本来なら1時間で終わるはずが3時間）

---

## 🎓 今後の改善策

### 1. デバッグファースト
```javascript
// 最初から全ポイントにログ
console.log('🔍 開始:', input);
console.log('📝 処理結果:', result);
console.log('📥 取得データ:', fetched);
console.log('✅ 最終表示:', displayed);
```

### 2. DB確認ファースト
```sql
-- 修正前後でDBの実データを確認
SELECT * FROM signage_profiles WHERE id = 'xxx';
```

### 3. RLSチェックリスト
```
□ SELECT権限あるか？
□ INSERT権限あるか？
□ UPDATE権限あるか？（全カラム）
□ DELETE権限あるか？
```

### 4. テスト完了の定義
```
□ コード修正完了
□ ローカルテスト完了
□ コンソールエラー0件
□ DB実データ確認
□ UI表示確認
□ ユーザーに報告
```

---

## 💡 学んだこと

1. **RLSポリシーは最初に確認する**
2. **テストしてから報告する**
3. **推測ではなく、データで確認する**
4. **ワークアラウンドより根本修正**
5. **ログは最初から詳細に**

---

**次回から、このチェックリストに従って効率的に作業します。**

**反省**: ユーザーに何度も確認させてしまい、申し訳ありませんでした。
